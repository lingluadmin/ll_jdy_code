/**
 * Created by scofie on 8/18/17.
 */

var JdyApp = angular.module('jdyApp', [], function ($interpolateProvider) {
    $interpolateProvider.startSymbol('{%');
    $interpolateProvider.endSymbol('%}');
});

JdyApp.controller('homeCtrl',function ($scope,$http,$timeout,$filter) {
    $scope.method   =   'GET' ;
    $scope.methodUrl=   '/home/getPacket' ;
    $scope.code         =   '' ;
    $scope.data         =   {} ;
    $scope.current      =   {} ;    //current project
    $scope.carList      =   {} ;    //car project
    $scope.consumeList  =   {} ;    //sunsum project
    $scope.houseList    =   {} ;    //house  project
    $scope.assignList   =   {} ;    //assign project
    $scope.noviceProject   =   {} ;    //assign project
    $scope.userData     =   {} ;
    $scope.userData.status  =   false
    $scope.bannerList   =   {} ;
    $scope.indexButton  =   {}
    $scope.indexDisplay =   false;
    $scope.homeStat     =   {}

    $timeout(function () {
        $http({method: $scope.method, url: $scope.methodUrl,cache: false}).
        then(function successCallback(response) {
            $scope.status   = response.status;
            $scope.data     = response.data;
            //get index show project
            if( $scope.status == 200 ) {
                $scope.consumeList  =  $scope.getProjectList('consume',$scope.data.projectList);
                $scope.houseList    =  $scope.getProjectList('house',$scope.data.projectList);
                $scope.assignList   =  $scope.getProjectList('assign',$scope.data.projectList);
                $scope.carList      =  $scope.getProjectList('car',$scope.data.projectList);
                $scope.noviceProject=  $scope.getProjectList('novice',$scope.data.projectList);
                $scope.current      =  $scope.getProjectList('current',$scope.data);
            }
            //get newslist
            if( $scope.status ==200 ) {
                //$scope.bannerList   =   $scope.getIndexNewsList('banner' ,$scope.data);
                $scope.mediaList    =   $scope.getIndexNewsList('media' ,$scope.data.articleList);
                $scope.newestList   =   $scope.getIndexNewsList('newest' ,$scope.data.articleList);
                $scope.noticeList   =   $scope.getIndexNewsList('notice' ,$scope.data.articleList);
                $scope.refundList   =   $scope.getIndexNewsList('refund' ,$scope.data.articleList);
                $scope.userData     =   $scope.data.userData;
                $scope.indexButton  =   $scope.setIndexButton($scope.data.indexButton) ;
                $scope.homeStat     =   $scope.data.stat ;
            }
            $scope.indexDisplay =   true;
        }, function errorCallback(response) {
            $scope.data     = response.data || 'Request failed';
            $scope.status   = response.status;
        })
    } ,80)
    //search index projectList
    $scope.getProjectList   =   function ( projectType , responseData ) {
        var typeConfig      =   new Array() ;
        typeConfig['consume'] = 'consumeProjectList';
        typeConfig['car']     = 'carProjectList';
        typeConfig['house']   = 'houseProjectList';
        typeConfig['assign']  = 'assignProjectList';
        typeConfig['current'] = 'current';
        typeConfig['novice']  = 'noviceList';
        dataType    =   typeConfig[projectType] ? typeConfig[projectType] : null;
        if( dataType ==null || !responseData[dataType] ) {
            return '';
        }
        return responseData[dataType];
    }
    $scope.getIndexNewsList =   function (news,responseData) {
        newsConfig  =  newsList  = new Array() ;
        newsNoteConfig  =   new Array();
        newsConfig['banner'] = 'bannerList';
        newsConfig['media']  = 'media';
        newsConfig['newest'] = 'newest';
        newsConfig['notice'] = 'notice';
        newsConfig['refund'] = 'refund';
        newsNoteConfig['banner'] = 'Index Banner' ;
        newsNoteConfig['media'] = '媒体报道' ;
        newsNoteConfig['newest'] = '最新消息' ;
        newsNoteConfig['notice'] = '平台公告' ;
        newsNoteConfig['refund'] = '回款公告' ;
        newsType    =   newsConfig[news] ? newsConfig[news] : null;

        if( newsType ==null || !responseData[newsType]) {
            return {id:0,title: "暂无" + newsNoteConfig[news]}
        }
        newsList    =    responseData[newsType];
        newsList.forEach( news => {
            if( news.publish_time ){
                news.push_time   = $filter('date')(new Date(news.publish_time), "MM.dd") ;
            } else {
                news.push_time   = $filter('date')(new Date(news.publish_at), "MM.dd")  ;
            }
        });

        return newsList;
    }
    $scope.setIndexButton   =   function (bottonInfo) {
        if( !bottonInfo.BANK_TIMES ) {
            bottonInfo.BANK_TIMES   =   '5';
        }
        if( !bottonInfo.BUTTON_TEXT ) {
            bottonInfo.BUTTON_TEXT  =  "立即注册" ;
        }
        if( !bottonInfo.CONTENT_WORD ) {
            bottonInfo.CONTENT_WORD =   '银行定期存款收益';
        }
        if( !bottonInfo.BANK_NOTE ) {
            bottonInfo.BANK_NOTE    =   "倍";
        }

        return bottonInfo ;
    }
    $scope.setBlock = function (status) {
        var block = "none";
        if (status == true) {
            block = 'block';
        }
        return {"display": block};
    };
    //open project detail
    $scope.jumpToDetail   =   function (id) {
        if( id ) {
            $scope.jumpUrl  =   '/project/detail/' + id
        } else {
            $scope.jumpUrl  =   '/project/index' ;
        }
        window.location.href = $scope.jumpUrl;
    }
});
JdyApp.filter('limitString',function () {
    var stringFilter    =   function (inputString,start,end) {
        if( inputString.length < 1 ) {
            return inputString ;
        }
        if( !start ){
            start = 0 ;
        }
        return inputString.substring(start,end)
    }
    return stringFilter ;
});
JdyApp.filter('investNote' ,function () {
    var investNote  =  function (investCash) {
        var formatCash  =   '';
        if ( investCash <=10000 ) {
            return 1 +" 万" ;
        }
        investCash  =   Math.round(investCash/10000);

        if( investCash / 10000 >=1 ) {

            return Math.floor (investCash / 10000) + '亿' + (investCash- Math.floor (investCash / 10000)*10000 ) + '万';
        }
        return Math.round(investCash) + '万' ;
    }

    return investNote;
});
JdyApp.filter('init_time' ,function () {
    var initTime    =   function (inputTime) {
        if( !inputTime ) {
            return "3年6个月10天";
        }
        return inputTime['y'] + "年" + inputTime['m'] + "个月" + inputTime['d'] + '天' ;
    }
    return initTime;
});
JdyApp.filter('borrowCount' ,function () {
    var borrowCount =   function (investNumber) {

        if ( investNumber <=10000 ) {
            return investNumber ;
        }

        if( investNumber / 100000000 >=1 ) {

            return Math.floor (investNumber / 100000000) + '亿' + (investNumber- Math.floor (investNumber / 100000000) * 100000000 )+ '万' + (investNumber -Math.floor (investNumber / 100000000) *100000000-Math.floor (investNumber / 10000) *10000 );
        }

        firstNumber =  Math.floor (investNumber / 10000);

        lastNumbr   =  investNumber- firstNumber*10000;

        return  firstNumber + '万' + lastNumbr ;
    }
    return  borrowCount ;
})
